## load libraries

library(TESS)
library(BDS)
library(ggplot2)
library(ape)
library(ggtree)
library(tidytree)
library(dplyr)


## The model
lambda <- c(0.007213066117787695, 0.02513926987812432, 0.05695189948393688, 0.11956344947502529, 0.27086568502054126, 0.9440320448002322,
            0.007213066117787695, 0.02513926987812432, 0.05695189948393688, 0.11956344947502529, 0.27086568502054126, 0.9440320448002322,
            0.007213066117787695, 0.02513926987812432, 0.05695189948393688, 0.11956344947502529, 0.27086568502054126, 0.9440320448002322,
            0.007213066117787695, 0.02513926987812432, 0.05695189948393688, 0.11956344947502529, 0.27086568502054126, 0.9440320448002322,
            0.007213066117787695, 0.02513926987812432, 0.05695189948393688, 0.11956344947502529, 0.27086568502054126, 0.9440320448002322,
            0.007213066117787695, 0.02513926987812432, 0.05695189948393688, 0.11956344947502529, 0.27086568502054126, 0.9440320448002322)
mu <- c(0.0036065330588938476, 0.0036065330588938476, 0.0036065330588938476, 0.0036065330588938476, 0.0036065330588938476, 0.0036065330588938476,
        0.012569634939062163, 0.012569634939062163, 0.012569634939062163, 0.012569634939062163, 0.012569634939062163, 0.012569634939062163,
        0.028475949741968435, 0.028475949741968435, 0.028475949741968435, 0.028475949741968435, 0.028475949741968435, 0.028475949741968435,
        0.059781724737512636, 0.059781724737512636, 0.059781724737512636, 0.059781724737512636, 0.059781724737512636, 0.059781724737512636,
        0.13543284251027063, 0.13543284251027063, 0.13543284251027063, 0.13543284251027063, 0.13543284251027063, 0.13543284251027063,
        0.47201602240011603, 0.47201602240011603, 0.47201602240011603, 0.47201602240011603, 0.47201602240011603, 0.47201602240011603)
eta <- 0.1



## Simulate phylogenies of different size

phys <- list()
ntaxa <- c(8, 16, 32, 64, 128, 256, 512, 1024, 2048, 4096, 8192, 16384, 32768)

set.seed(123)
phys <- list()
for (i in seq_along(ntaxa)){
  phy <- TESS::tess.sim.taxa.age(1, ntaxa[i], 2.0, 1.0, 0.5)[[1]]
  ## Save them to a file
  write.tree(phy, file = paste0("/home/bkopper/projects/BDS_deterministic_map/data/simulated_trees/", ntaxa[i], ".tre"))
  phys[[i]] <- phy
}



## Test how much time we need to execute program
times1 <- list()
for (i in seq_along(phys)){
  if (ntaxa[i] < 300){
    t1 <- Sys.time()
    res <- birth_death_shift(phys[[i]], lambda, mu, eta)
    t2 <- Sys.time()
    cat(".")

    times1[[i]] <- t2 - t1
  }
};cat("\n")


times2 <- list()
for (i in seq_along(phys)){
  if (ntaxa[i] < 300){
    ## RCPP implementation (postorder+logL only)
    t1 <- Sys.time()
    res <- birth_death_shift2(phys[[i]], lambda, mu, eta)
    t2 <- Sys.time()
    cat(".")

    times2[[i]] <- t2 - t1
  }
};cat("\n")


df <- tibble("tnativeR" = unlist(times1),
             "tRcpp" = unlist(times2),
             "ntaxa" = ntaxa[1:6])

## Save the runtime results to a file
write.table(df, file = "output/runtimes_r.csv", sep = ";", row.names = FALSE)

# p <- ggplot(df, aes(x = ntaxa, y = times)) +
#   geom_point() +
#   theme_classic() +
#   geom_smooth(method = "lm")
#
#
# ###### USE THE BEARS DATASET
#
# lambda <- c(0.02534921916243207, 0.0883481242675137, 0.20014875202307267, 0.4201874813104264, 0.9519160785502293, 3.3176564319834108,
#             0.02534921916243207, 0.0883481242675137, 0.20014875202307267, 0.4201874813104264, 0.9519160785502293, 3.3176564319834108,
#             0.02534921916243207, 0.0883481242675137, 0.20014875202307267, 0.4201874813104264, 0.9519160785502293, 3.3176564319834108,
#             0.02534921916243207, 0.0883481242675137, 0.20014875202307267, 0.4201874813104264, 0.9519160785502293, 3.3176564319834108,
#             0.02534921916243207, 0.0883481242675137, 0.20014875202307267, 0.4201874813104264, 0.9519160785502293, 3.3176564319834108,
#             0.02534921916243207, 0.0883481242675137, 0.20014875202307267, 0.4201874813104264, 0.9519160785502293, 3.3176564319834108)
# mu <- c(0.017482220112022114, 0.017482220112022114, 0.017482220112022114, 0.017482220112022114, 0.017482220112022114, 0.017482220112022114,
#         0.06092974087414737, 0.06092974087414737, 0.06092974087414737, 0.06092974087414737, 0.06092974087414737, 0.06092974087414737,
#         0.13803362208487774, 0.13803362208487774, 0.13803362208487774, 0.13803362208487774, 0.13803362208487774, 0.13803362208487774,
#         0.2897844698692596, 0.2897844698692596, 0.2897844698692596, 0.2897844698692596, 0.2897844698692596, 0.2897844698692596,
#         0.6564938472760203, 0.6564938472760203, 0.6564938472760203, 0.6564938472760203, 0.6564938472760203, 0.6564938472760203,
#         2.2880389186092494, 2.2880389186092494, 2.2880389186092494, 2.2880389186092494, 2.2880389186092494, 2.2880389186092494)
#
# lambda <- c(0.05, 0.1, 0.15, 0.2)
# mu <- lambda*0.5
# eta <- 0.1
#
# bears <- read.nexus("/home/bkopper/projects/BDS_deterministic_map/data/bears.tre")
# res <- birth_death_shift(bears, lambda, mu, eta, ntimes = 100)
#
# #res$x$forward[[14]]
#
#
# print(res$x$forward[[14]], n = 100)
# print(res$x$backward[[14]], n = 100)
#
# plotvar <- function(x, var, edge_idx){
#   dfs <- list()
#   for (i in 1:4){
#     mytime <- x$forward[[edge_idx]]$time
#     dfs[[i]] <- dplyr::tibble("time" = mytime,
#                               "value" = x$forward[[edge_idx]][[paste0(var,i)]],
#                               "state" = as.character(i))
#   }
#   return(bind_rows(dfs))
# }
#
# plotvar(res$x, "F", 14) %>%
#   ggplot(aes(x = time, y = value, color = state)) +
#   geom_line() +
#   ylim(c(0.0, 0.05))
#
#
# plotvar(res$x, "D", 14) %>%
#   ggplot(aes(x = time, y = value, color = state)) +
#   geom_line() +
#   ylim(c(-0.05, 1.0))
#
#
#
# th <- max(node.depth.edgelength(bears))
#
# df1 <- tibble("node" = bears$edge[,2],
#               "Speciation rate" = res$mean_rates$lambda)
# df1 <- bind_rows(df1,
#                  tibble("node" = length(bears$tip.label)+1,
#                         "Speciation rate" = NaN))
# x <- as_tibble(bears)
#
# phydf <- merge(x, df1, by = "node")
# td_phy <- as.treedata(phydf)
#
# p1a <- ggtree(td_phy, aes(color = `Speciation rate`)) +
#   ggtitle("backwards-forwards approach")
#
# plot(p1a)
# # p1 <- p1a +
# #   geom_tiplab() +
# #   theme(legend.position = c(0.2, 0.8)) +
# #   xlim(c(0.0, th + 10))
#
# jl_root_probs <- c(0.04386266560367923, 0.23446662413160865, 0.21282625398381, 0.007404035838374703, 0.0016013378808027805, -0.00035306339766109554, 0.015572533062032748, 0.09040024959210628, 0.18384490494056457, 0.010242848683866136, 0.0017701056288519413, -0.00015690283410896684, 0.0032846566106994788, 0.01933490132326041, 0.08624043301350627, 0.018042694304990906, 0.0021356485496511154, 0.00013888896423053116, 0.0004908885638214059, 0.002556944467751941, 0.011888509750342302, 0.03023641810385839, 0.0032151288163093103, 0.00038442437353754174, 7.507084464923583e-5, 0.00031654498002823205, 0.0010382250750447016, 0.004949674630248533, 0.009860946198682996, 0.0005494912250422693, 5.413036506028798e-6, 1.9918047407318432e-5, 4.987300302798442e-5, 0.00012945615670684204, 0.000542706672194363, 0.003031550174575024)
# plot(1:36, jl_root_probs - res$x$root_probs)
#
#
#
# db <- res$x$backward[[14]] %>% select(starts_with("D")) %>% tail(n = 1) %>% unlist()
#
# df <- res$x$forward[[14]] %>% select(starts_with("D")) %>% head(n = 1) %>% unlist()
#
# ff <- res$x$forward[[14]] %>% select(starts_with("F"))
#
# plot(1:100, ff$F1)
#
# ff$F1
#
# jlff <- c(0.0014313926284679984, 0.0015193340268377983, 0.001594900037316164, 0.0016607076643627846, 0.001718400738875435, 0.0017690892241839765, 0.0018135785585109648, 0.0018524917378837911, 0.0018863360218668802, 0.0019155387891134185, 0.001940472245065384, 0.001961464193796965, 0.0019788098918093015, 0.001992774961241393, 0.002003603460214167, 0.0020115178756861894, 0.0020167234253194023, 0.002019411124416587, 0.002019757013188531, 0.002017924694513642, 0.002014067798500612, 0.002008329949968626, 0.0020008442922005965, 0.001991735958659656, 0.0019811230437369047, 0.001969116645477242, 0.001955820479589398, 0.0019413315921490027, 0.0019257419509868617, 0.0019091385237595883, 0.0018916033072473805, 0.0018732132741162918, 0.0018540402281519808, 0.0018341522264616274, 0.0018136137798764106, 0.0017924858529515095, 0.0017708258605970547, 0.0017486874059756776, 0.0017261214333624893, 0.0017031763011055405, 0.001679897409224375, 0.001656327199410029, 0.0016325051550250317, 0.00160846768403909, 0.0015842485857913166, 0.0015598857413470823, 0.0015354136644700064, 0.0015108614585446047, 0.0014862528165762903, 0.0014616066492662847, 0.0014369505185593497, 0.0014123170800545489, 0.0013877299952687657, 0.001363203564267765, 0.00133874548946712, 0.0013143809022269093, 0.0012901336919171644, 0.0012660187316835493, 0.0012420430865449285, 0.001218218027781254, 0.001194562837322777, 0.0011710902348768576, 0.0011478082190693865, 0.0011247227471523286, 0.0011018466901200762, 0.00107919027087578, 0.0010567606167076569, 0.0010345620746467906, 0.0010126013714627392, 0.0009908868735259936, 0.0009694244849194071, 0.0009482179426679283, 0.0009272695352494893, 0.0009065848145004391, 0.0008861689909432971, 0.0008660252730548657, 0.0008461549568199272, 0.0008265587167274909, 0.0008072408043359027, 0.0007882044809720515, 0.000769451047528209, 0.000750979869906722, 0.0007327904236309535, 0.0007148861449988634, 0.0006972690019976789, 0.0006799388740854005, 0.0006628935630848387, 0.0006461321358971086, 0.0006296575942943722, 0.0006134709806863884, 0.000597571127301459, 0.0005819547877891993, 0.0005666217994763211, 0.0005515750335537537, 0.0005368151746669667, 0.000522340787388522, 0.0005081493058643269, 0.000494244098464291, 0.0004806284984631013, 0.0004673057486649179)
#
# plot(jlff, ff$F1, ylim = c(0.0, 0.01), xlim = c(0.0, 0.01))
#
# ff$F1[1:5]
#
# res$x$backward[[14]]$D1
#
#
# d14 <- print(res$x$forward[[14]][,c(1,36*1+2)], n = 100)
#
# d14$D1
#
#
# res$x$forward[[6]] %>% select(starts_with("F")) %>% tail(n = 1) %>% unlist()
#
