library(microbenchmark)
library(magrittr)
library(deSolve)

source("scripts/ODE.branch.backwards.R")
source("scripts/ODE.branch.backwards.rk4.R")

## A model
lambda <- c(0.007213066117787695, 0.02513926987812432, 0.05695189948393688, 0.11956344947502529, 0.27086568502054126, 0.9440320448002322, 0.007213066117787695, 0.02513926987812432, 0.05695189948393688, 0.11956344947502529, 0.27086568502054126, 0.9440320448002322, 0.007213066117787695, 0.02513926987812432, 0.05695189948393688, 0.11956344947502529, 0.27086568502054126, 0.9440320448002322, 0.007213066117787695, 0.02513926987812432, 0.05695189948393688, 0.11956344947502529, 0.27086568502054126, 0.9440320448002322, 0.007213066117787695, 0.02513926987812432, 0.05695189948393688, 0.11956344947502529, 0.27086568502054126, 0.9440320448002322, 0.007213066117787695, 0.02513926987812432, 0.05695189948393688, 0.11956344947502529, 0.27086568502054126, 0.9440320448002322)
mu <- c(0.0036065330588938476, 0.0036065330588938476, 0.0036065330588938476, 0.0036065330588938476, 0.0036065330588938476, 0.0036065330588938476, 0.012569634939062163, 0.012569634939062163, 0.012569634939062163, 0.012569634939062163, 0.012569634939062163, 0.012569634939062163, 0.028475949741968435, 0.028475949741968435, 0.028475949741968435, 0.028475949741968435, 0.028475949741968435, 0.028475949741968435, 0.059781724737512636, 0.059781724737512636, 0.059781724737512636, 0.059781724737512636, 0.059781724737512636, 0.059781724737512636, 0.13543284251027063, 0.13543284251027063, 0.13543284251027063, 0.13543284251027063, 0.13543284251027063, 0.13543284251027063, 0.47201602240011603, 0.47201602240011603, 0.47201602240011603, 0.47201602240011603, 0.47201602240011603, 0.47201602240011603)
eta <- 0.1
th <- 101.35870000000006
u0 <- rep(0, 36)

D0 <- rep(1, 36)
E0 <- rep(0, 36)


## Extinction probability with RK4
jlout <- c(0.4850964940946081, 0.4437570604533107, 0.3765270208141392, 0.27719262396713173, 0.16012131111660166, 0.05352103230746553, 0.5251582092164383, 0.4863402559397395, 0.420547768518516, 0.3167000805443981, 0.18585029621108173, 0.06241169285715948, 0.5830643744445011, 0.5490189402968271, 0.48807346626485015, 0.38162657640698044, 0.23059819341439536, 0.07822466107908804, 0.6642500445601648, 0.6384572975091787, 0.5893881553906875, 0.49042578214062316, 0.31488959517627607, 0.10926594486929427, 0.7722939405549242, 0.7582783635772593, 0.7305677067480308, 0.665995786429965, 0.493490012923165, 0.1836609503869993, 0.906767282801069, 0.9040340621995975, 0.8988180276383898, 0.8869773947686568, 0.8466523479460075, 0.4973007907697798)
rout <- extinction.rk4(lambda, mu, eta, 0, th, u0, ntimes = 100) %>%
  tail(n = 1) %>%
  (function (e) e[2:length(e)])

#plot(jlout, rout)
plot(1:36, jlout - rout)
#plot(1:36, jlout - )

## Benchmarking D with Euler's method
microbenchmark(
  branch.prob.backwards(lambda, mu, eta, th, D0, E0, STEPS = 100)
)

euler_out <- list()
STEPS <- c(50, 100, 1000, 10000, 100000)
for (i in seq_along(STEPS)){
  euler_out[[i]] <- branch.prob.backwards(lambda, mu, eta, th, D0, E0, STEPS = STEPS[i])
}

euler_out[[2]]
rk4_out <- backwards.rk4two(lambda, mu, eta, 0.0, th, E0, D0, ntimes = 1000) %>%
  tail(n = 1) %>%
  unlist() %>%
  (function(x) x[2:length(x)]) %>%
  (function(x) x[(k+1):(2*k)])

for (i in 1:5){
  sse <- sum((rk4_out - euler_out[[i]]$D)^2)
  print(paste0("sum squared errors (nsteps = ", STEPS[i], "): ", sse))
}

## Validating D, rk4 vs Euler's method

microbenchmark(
  backwards.rk4two(lambda, mu, eta, 0.0, th, E0, D0, ntimes = 42)
)

backwards.rk4two(lambda, mu, eta, 0.0, th, E0, D0, ntimes = 100) %>%
  tail(n = 1)

Djlout <- c(0.0007035829537347679, 0.0006463724638538184, 0.0004943481529009387, 0.00027294437582171756, 0.00010912955720281646, 2.5786211247489438e-5, 0.0005654807808936623, 0.0005475862700061233, 0.0004575176828309717, 0.0002744611041741909, 0.00011167885155529253, 2.7117514535113045e-5, 0.0004157634140461574, 0.00042399220799713903, 0.0003957437329357411, 0.0002732606348145485, 0.00011622752119915438, 2.7922581778816546e-5, 0.0002717564595274383, 0.00028673317985501246, 0.00029809269454009467, 0.000257648585183573, 0.00012499687400775278, 2.8808840398969334e-5, 0.00014709991467310078, 0.00015582943917826322, 0.00017067219781926788, 0.00018885009094925974, 0.00014058536662705444, 3.120148216401039e-5, 4.791937807258345e-5, 4.9355381387478745e-5, 5.206797800951956e-5, 5.805410941774432e-5, 7.563961446001222e-5, 4.68832352460375e-5)

Drout <- list()
for (i in seq_along(STEPS)){
  Drout[[i]] <- backwards.rk4two(lambda, mu, eta, 0.0, th, E0, D0, ntimes = STEPS[i]) %>%
    tail(n = 1) %>%
    (function(e) e[2:length(e)]) %>%
    (function(e) e[(k+1):(2*k)])
}

par(mfrow = c(2,3)); for (i in seq_along(STEPS)){
  plot(1:k, Djlout - Drout[[i]], main = paste0(STEPS[i], " knots"), ylab = "Jl (Tsit5, adaptive) - R (RK4, n knots)", ylim = c(-0.00001, 0.00001))
};par(mfrow = c(1,1))

library(ape)
phy <- read.tree("data/actinopterygii/actinopt_full_1.tree")

microbenchmark(
  which(phy$edge[,2] == 300)
)

# 419 (microseconds)
419 * nrow(phy$edge) * 3 / (1000 * 1000)







